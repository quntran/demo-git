name: Auto set overdue status in User Project #2

on:
  workflow_dispatch:
  schedule:
    - cron: "* * * * *"   # 7h04 s√°ng VN (0h UTC)

jobs:
  mark-overdue:
    runs-on: ubuntu-latest
    permissions:
      issues: read
      repository-projects: write
      contents: read

    steps:
      - name: Check overdue items and update Status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.USER_PAT }}
          script: |
            const today = new Date().toISOString().slice(0,10);
            console.log(`üìÖ H√¥m nay: ${today}`);

            // 1Ô∏è‚É£ L·∫•y to√†n b·ªô task trong project
            const projectQuery = `
              query {
                viewer {
                  projectV2(number: 2) {
                    id
                    title
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          __typename
                          ... on Issue { title number url }
                          ... on PullRequest { title number url }
                        }
                        deadlineField: fieldValueByName(name: "Deadline") {
                          __typename
                          ... on ProjectV2ItemFieldDateValue { date }
                        }
                        statusField: fieldValueByName(name: "Status") {
                          __typename
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            name
                            optionId
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const res = await github.graphql(projectQuery);
            const project = res.viewer.projectV2;
            if (!project) {
              console.log("‚ùå Kh√¥ng t√¨m th·∫•y Project #2 (private?). Ki·ªÉm tra quy·ªÅn USER_PAT.");
              return;
            }

            console.log(`üóÇÔ∏è Project: ${project.title}`);

            const items = project.items.nodes;
            const overdueItems = items.filter(item => {
              const deadline = item.deadlineField?.date;
              return deadline && new Date(deadline) < new Date(today);
            });

            console.log(`‚è∞ C√≥ ${overdueItems.length} task tr·ªÖ h·∫°n.`);

            // 2Ô∏è‚É£ L·∫•y fieldId v√† optionId c·ªßa Status ‚Üí Overdue
            const fieldsQuery = `
              query($projectId:ID!) {
                node(id:$projectId) {
                  ... on ProjectV2 {
                    fields(first: 50) {
                      nodes {
                        __typename
                        ... on ProjectV2FieldCommon {
                          id
                          name
                          dataType
                        }
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                            color
                            description
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const fieldRes = await github.graphql(fieldsQuery, { projectId: project.id });
            const fields = fieldRes.node.fields.nodes;

            const statusField = fields.find(f => f.name === "Status");
            const overdueOption = statusField?.options?.find(o => o.name === "Overdue");
            const doneOption = statusField?.options?.find(o => o.name === "Done");

            if (!statusField) {
              console.log("‚ùå Kh√¥ng t√¨m th·∫•y field 'Status'.");
              console.log("üìã Field list:", fields.map(f => f.name).join(", "));
              return;
            }
            if (!overdueOption) {
              console.log("‚ùå Kh√¥ng t√¨m th·∫•y option 'Overdue' trong field 'Status'.");
              console.log("üìã Options:", statusField.options.map(o => o.name).join(", "));
              return;
            }

            const fieldId = statusField.id;
            const overdueOptionId = overdueOption.id;
            const doneOptionId = doneOption.id;

            console.log(`üÜî Field ID: ${fieldId}`);
            console.log(`üÜî Option ID (Overdue): ${overdueOptionId}`);
            console.log(`üÜî Option ID (Done): ${doneOptionId}`);

            // 3Ô∏è‚É£ Mutation c·∫≠p nh·∫≠t Status
            const updateMutation = `
              mutation($projectId:ID!, $itemId:ID!, $fieldId:ID!, $optionId:String!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { singleSelectOptionId: $optionId }
                  }
                ) {
                  projectV2Item { id }
                }
              }
            `;

            // 4Ô∏è‚É£ C·∫≠p nh·∫≠t t·ª´ng task tr·ªÖ h·∫°n
            for (const item of overdueItems) {
              const title = item.content?.title || "(Kh√¥ng c√≥ ti√™u ƒë·ªÅ)";
              if (item.statusField?.name === "Overdue") {
                console.log(`‚è≠Ô∏è B·ªè qua: ${title} (ƒë√£ Overdue)`);
                continue;
              } else if (item.statusField?.name === "Done") {
                console.log(`‚è≠Ô∏è B·ªè qua: ${title} (ƒë√£ Done)`);
                continue;
              }

              console.log(`‚öôÔ∏è Update Status ‚Üí Overdue: ${title}`);
              try {
                await github.graphql(updateMutation, {
                  projectId: project.id,
                  itemId: item.id,
                  fieldId: fieldId,
                  optionId: overdueOptionId,
                });
              } catch (err) {
                console.log(`‚ùå L·ªói c·∫≠p nh·∫≠t ${title}: ${err.message}`);
              }
            }

            console.log("‚úÖ Ho√†n t·∫•t c·∫≠p nh·∫≠t Status = Overdue cho t·∫•t c·∫£ task tr·ªÖ h·∫°n.");